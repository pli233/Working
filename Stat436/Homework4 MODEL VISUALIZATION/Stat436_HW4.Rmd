---
title: "Stat 436 Homework-4"
author: "Peiyuan Li"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    highlight: tango
    fig_width: 6
    fig_height: 4
    df_print: paged
  pdf_document:
    toc: true
---
```{r setup}
#Hide unnecessary output and warning message such as library(tidyverse)
knitr::opts_chunk$set(warnings = FALSE, message = FALSE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(tidymodels)
library(broom)
diamonds_df <- read_csv("./diamonds.csv")
```

```{r}

# 加载所需的库
library(dplyr)
library(tidymodels)
library(ggplot2)

# 对'cut', 'clarity', 和 'color'列进行数值编码
diamonds_df <- diamonds_df %>%
  mutate(
    cut = recode(cut, "Ideal" = 5, "Premium" = 4, "Very Good" = 3, "Good" = 2, "Fair" = 1),
    clarity = recode(clarity, "I1" = 1, "SI2" = 2, "SI1" = 3, "VS2" = 4, "VS1" = 5, "VVS2" = 6, "VVS1" = 7, "IF" = 8),
    color = recode(color, "J" = 1, "I" = 2, "H" = 3, "G" = 4, "F" = 5, "E" = 6, "D" = 7)
  )

# 创建PCA配方并排除'price'变量
pca_recipe <- recipe(~ . - price, data = diamonds_df) %>%
  step_normalize(all_predictors(), -all_outcomes()) %>%
  step_pca(all_predictors(), -all_outcomes(), threshold = 0.95)

# 准备并应用PCA配方
pca_prep <- prep(pca_recipe)
pca_summary <- tidy(pca_prep, number = 1)  # 获取主成分摘要

# 将PCA应用于数据集
diamonds_transformed <- bake(pca_prep, new_data = NULL)

# 将主成分和原始价格数据结合起来
diamonds_transformed <- bind_cols(diamonds_transformed, diamonds_df %>% select(price))

# 使用主成分作为预测变量建立线性模型
lm_model <- lm(price ~ ., data = diamonds_transformed)
lm_summary <- summary(lm_model)

# 输出模型摘要来查看哪些主成分对价格影响最大
print(lm_summary)

# 使用tidy()从lm模型中提取系数并进行排序，以确定影响最大的变量
tidy_lm <- tidy(lm_model)
top_influencers <- tidy_lm %>%
  arrange(desc(abs(estimate)))  # 根据估计系数的绝对值排序

# 输出影响最大的几个系数
print(top_influencers)

# 如果您想要直观展示影响最大的变量，可以绘制一个系数图
ggplot(top_influencers, aes(x = reorder(term, estimate), y = estimate, fill = estimate > 0)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(x = "Variables", y = "Coefficients", title = "Top Influencers on Diamond Price")



```

```{r data_preprocess}

# Recoding cut, clarity, and color columns into number
diamonds_df <- diamonds_df %>%
  mutate(
    cut = recode(cut,
                 "Ideal" = 5,
                 "Premium" = 4,
                 "Very Good" = 3,
                 "Good" = 2,
                 "Fair" = 1),
    clarity = recode(clarity,
                     "I1" = 1,
                     "SI2" = 2,
                     "SI1" = 3,
                     "VS2" = 4,
                     "VS1" = 5,
                     "VVS2" = 6,
                     "VVS1" = 7,
                     "IF" = 8), 
    color = recode(color,
                   "J" = 1,
                   "I" = 2,
                   "H" = 3,
                   "G" = 4,
                   "F" = 5,
                   "E" = 6,
                   "D" = 7)
  )

# Viewing the first few rows to confirm the changes
head(diamonds_df)
```


```{r}
temp <- diamonds_df %>%  select(-price)

# Step 1: Specify the recipe
pca_recipe <- recipe(~ ., data = temp) %>%
  step_normalize(all_numeric(), -all_outcomes()) %>%
  step_pca(all_numeric(), -all_outcomes(), threshold = 0.95)

# Step 2: Prepare and train the recipe
pca_prep <- prep(pca_recipe)

# Step 3: Extract variances for PCA components
tidied_pca <- tidy(pca_prep, 2)

tidied_pca %>%
  filter(component %in% paste0("PC", 1:5)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(value, terms, fill = terms)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~component, nrow = 1) +
  labs(y = NULL)
```

```{r}
library(tidytext)

tidied_pca %>%
  filter(component %in% paste0("PC", 1:4)) %>%
  group_by(component) %>%
  top_n(8, abs(value)) %>%
  ungroup() %>%
  mutate(terms = reorder_within(terms, abs(value), component)) %>%
  ggplot(aes(abs(value), terms, fill = value > 0)) +
  geom_col() +
  facet_wrap(~component, scales = "free_y") +
  scale_y_reordered() +
  labs(
    x = "Absolute value of contribution",
    y = NULL, fill = "Positive?"
  )


```


